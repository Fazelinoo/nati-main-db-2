<!DOCTYPE html>
<html lang="fa">
<script>
//  tanzim kardan dark mod va light mode
(function() {
    try {
        var html = document.documentElement;
        if (localStorage.getItem('theme') === 'dark') {
            html.classList.add('dark');
        } else {
            html.classList.remove('dark');
        }
    } catch (e) {}
})();
</script>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Nati{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <style>
    :root {
        --main-bg-light: #f7f8fa;
        --main-bg-dark: #181a23;
        --card-bg-light: #fcfcfd;
        --card-bg-dark: #23243a;
        --accent-light: #444;
        --accent-dark: #23243a;
        --border-light: #e5e7eb;
        --border-dark: #23243a;
        --text-light: #23243a;
        --text-dark: #e0eafc;
        --muted-light: #666;
        --muted-dark: #b3c6ff;
    }
    body {
        background: var(--main-bg-light);
        color: var(--text-light);
        transition: background 0.5s cubic-bezier(.4,2,.6,1), color 0.4s;
    }
    .navbar {
        background: #fff;
        border-bottom: 1px solid var(--border-light);
        box-shadow: none;
        transition: background 0.4s, box-shadow 0.4s;
        padding: 1.1rem 0 1.1rem 0;
        font-family: 'Inter', 'Vazirmatn', 'Tahoma', sans-serif;
        background: #f3f4f8cc;
        box-shadow: 0 4px 24px #bfc7d680;
        border: none;
        animation: fadeInUp 0.7s cubic-bezier(.4,2,.6,1);
    }
    .card {
        background: var(--card-bg-light);
        border-radius: 6px;
        box-shadow: none;
        border: 1px solid var(--border-light);
        padding: 2rem 1.5rem;
        margin-bottom: 2rem;
        font-family: 'Inter', 'Vazirmatn', 'Tahoma', sans-serif;
        animation: fadeInUp 0.7s cubic-bezier(.4,2,.6,1);
    }
    .btn, .form-control, .form-select {
        border-radius: 4px !important;
        border: 1px solid var(--border-light) !important;
        box-shadow: none !important;
        font-family: 'Inter', 'Vazirmatn', 'Tahoma', sans-serif;
        font-size: 1rem;
        padding: 0.6rem 1.1rem;
        transition: box-shadow 0.3s, background 0.3s, color 0.3s, border 0.3s;
    }
    .btn-primary, .btn-outline-primary {
        background: #222;
        border: 1px solid var(--border-light);
        color: #fff !important;
        background: var(--accent-light);
        border: none;
        box-shadow: 0 1px 4px #2222;
    }
    .btn-primary:hover, .btn-outline-primary:hover {
        background: #444;
        color: #fff !important;
    }
    .btn-outline-secondary:hover {
        background: var(--accent-light);
        color: #fff;
    }
    .footer {
        background: #fff;
        color: var(--muted-light);
        padding: 1.1rem 0 0.7rem 0;
        text-align: center;
        margin-top: 2rem;
        border-top: 1px solid var(--border-light);
        font-family: 'Inter', 'Vazirmatn', 'Tahoma', sans-serif;
        font-size: 1rem;
    }
    .form-control, .form-select {
        background: #f7f7f7;
        border: 1.5px solid var(--border-light);
        color: var(--text-light);
    }
    .form-control:focus, .form-select:focus {
        border-color: var(--accent-light);
        box-shadow: 0 0 0 0.2rem #6c63ff22;
    }
    .alert-info {
        background: #e3e6ed;
        color: var(--accent-light);
        border: none;
    }
    .alert-danger {
        background: #fff0f0;
        color: #ff6b6b;
        border: none;
    }
    .table-striped > tbody > tr:nth-of-type(odd) {
        background-color: #f8fafd;
    }
    .table-striped > tbody > tr:nth-of-type(even) {
        background-color: #e3e6ed;
    }

    html.dark body,
    body.dark {
        background: var(--main-bg-dark);
        color: var(--text-dark);
    }
    html.dark .navbar,
    body.dark .navbar {
        background: #23243acc;
        border-bottom: 1px solid var(--border-dark);
        box-shadow: 0 2px 12px #0004;
        color: var(--text-dark);
    }
    html.dark .card,
    body.dark .card {
        background: var(--card-bg-dark);
        color: var(--text-dark);
        box-shadow: 0 4px 24px #0008;
    }
    html.dark .footer,
    body.dark .footer {
        background: #23243acc;
        color: var(--muted-dark);
        border-top: 1px solid var(--border-dark);
    }
    html.dark .btn,
    body.dark .btn {
        background: #23243a !important;
        color: #e0eafc !important;
        border: 1.5px solid #5edfff !important;
        box-shadow: 0 2px 8px #0002;
    }
    html.dark .btn:hover,
    body.dark .btn:hover {
        background: #10111a !important;
        color: #5edfff !important;
    }
    html.dark .btn-outline-primary,
    body.dark .btn-outline-primary {
        background: #23243a !important;
        color: #5edfff !important;
        border: 1.5px solid #5edfff !important;
    }
    html.dark .btn-outline-primary:hover,
    body.dark .btn-outline-primary:hover {
        background: #5edfff !important;
        color: #23243a !important;
    }
    html.dark .vertical-actions,
    body.dark .vertical-actions {
        background: #181a23 !important;
        box-shadow: 0 4px 24px #23243a66;
    }
    html.dark .vertical-actions a,
    body.dark .vertical-actions a {
        background: #23243a !important;
        color: #e0eafc !important;
        border-top: 1.5px solid #23243a;
    }
    html.dark .vertical-actions a:hover,
    body.dark .vertical-actions a:hover {
        background: #10111a !important;
        color: #5edfff !important;
    }
    html.dark .user-list-box,
    body.dark .user-list-box {
        background: #23243a !important;
        color: #e0eafc !important;
        border: 1px solid #23243a !important;
    }
    html.dark .user-list-avatar,
    body.dark .user-list-avatar {
        background: #35364a !important;
        color: #e0eafc !important;
    }
    html.dark .user-list-info,
    body.dark .user-list-info {
        color: #e0eafc !important;
    }
    html.dark .user-tg-box,
    body.dark .user-tg-box {
        background: #23243a !important;
        color: #e0eafc !important;
    }
    html.dark .user-tg-avatar,
    body.dark .user-tg-avatar {
        background: #35364a !important;
        color: #e0eafc !important;
    }
    html.dark .user-tg-role,
    body.dark .user-tg-role {
        color: #5edfff !important;
    }
    html.dark .user-tg-status,
    body.dark .user-tg-status {
        color: #b3c6ff !important;
    }
    html.dark .card h2,
    body.dark .card h2 {
        color: #5edfff !important;
    }
    html.dark .card p,
    body.dark .card p {
        color: #b3c6ff !important;
    }
    .theme-switch {
        display: flex;
        align-items: center;
        cursor: pointer;
        margin-left: 1rem;
        user-select: none;
        position: relative;
        width: 48px;
        height: 28px;
        background: #23243a;
        border-radius: 14px;
        box-shadow: 0 2px 8px #23243a33;
        transition: background 0.4s;
    }
    .theme-switch input {
        display: none;
    }
    .theme-toggle-slider {
        position: absolute;
        top: 0; left: 0;
        width: 48px;
        height: 28px;
        background: transparent;
        border-radius: 14px;
        box-shadow: none;
        transition: background 0.4s;
    }
    .theme-toggle-knob {
        position: absolute;
        top: 3px;
        left: 3px;
        width: 22px;
        height: 22px;
        background: #fffbe6;
        border-radius: 50%;
        box-shadow: 0 2px 8px #f7c94833;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: left 0.4s cubic-bezier(.4,2,.6,1), background 0.4s, box-shadow 0.4s;
        z-index: 2;
    }
    .theme-switch input:checked ~ .theme-toggle-knob {
        left: 23px;
        background: #23243a;
        box-shadow: 0 2px 8px #6c63ff33;
    }
    .theme-toggle-knob .icon-sun, .theme-toggle-knob .icon-moon {
        position: absolute;
        width: 18px;
        height: 18px;
        transition: opacity 0.4s, transform 0.4s;
    }
    .theme-toggle-knob .icon-sun {
        color: #f7c948;
        opacity: 1;
        transform: scale(1) rotate(0deg);
    }
    .theme-switch input:checked ~ .theme-toggle-knob .icon-sun {
        opacity: 0;
        transform: scale(0.5) rotate(90deg);
    }
    .theme-toggle-knob .icon-moon {
        color: #5edfff;
        opacity: 0;
        transform: scale(0.5) rotate(-90deg);
    }
    .theme-switch input:checked ~ .theme-toggle-knob .icon-moon {
        opacity: 1;
        transform: scale(1) rotate(0deg);
    }
    </style>
    {% block extra_head %}{% endblock %}
</head>
<body dir="rtl">

<nav class="navbar navbar-expand-lg mb-4">
    <div class="container d-flex align-items-center justify-content-between">
        <a class="navbar-brand fw-bold" href="/">Nati</a>
        <!-- <a href="{% url 'project_list' %}" class="btn btn-outline-primary ms-2">پروژه‌ها و تسک‌ها</a> -->
        <div class="d-flex align-items-center gap-3 ms-auto">
            {% if user.is_authenticated %}
                <div class="position-relative me-2">
                    <button id="notifBtn" class="btn btn-outline-secondary position-relative" onclick="toggleNotifDropdown(event)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7v2.09c0 .32.15.62.41.8l1.59 1.06a1 1 0 0 1-.59 1.85H3.59a1 1 0 0 1-.59-1.85l1.59-1.06A1 1 0 0 0 5 11.09V9a7 7 0 0 1 7-7zm0 18a3 3 0 0 0 3-3H9a3 3 0 0 0 3 3z"/></svg>
                        {% if has_unread_message or has_new_file %}
                        <span id="notifDot" class="notif-dot-blink position-absolute top-0 start-0 translate-middle p-1 bg-danger border border-light rounded-circle" style="display:none;"></span>
<style>
@keyframes notif-blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.2; }
}
.notif-dot-blink {
  animation: notif-blink 1s infinite;
}
</style>
                        {% endif %}
                    </button>
</footer>
                    <div id="notifDropdown" class="card shadow p-3 position-fixed end-0 mt-2 notif-dropdown-fix" style="min-width:220px; display:none; z-index:2147483647; right:24px; top:70px; left:auto; box-shadow: 0 12px 48px #23243a99, 0 0 0 4px #6a8dff33;">
                        <a href="{% url 'user_tasks' %}" class="btn btn-outline-info w-100 mb-2">تسک‌های من</a>
</footer>
<style>
/* fix bug ke safhe notif zire baghie bakhs ha miraft */
.notif-dropdown-fix {
  z-index: 2147483647 !important;
  position: fixed !important;
  right: 24px !important;
  top: 70px !important;
  left: auto !important;
  background: var(--card-bg-light) !important;
  color: var(--text-light) !important;
  box-shadow: 0 12px 48px #bfc7d680, 0 0 0 4px #6a8dff33 !important;
  border: 1.5px solid var(--border-light) !important;
  transition: background 0.4s, color 0.4s, border 0.4s;
}
.dark .notif-dropdown-fix, html.dark .notif-dropdown-fix {
  background: var(--card-bg-dark) !important;
  color: var(--text-dark) !important;
  box-shadow: 0 12px 48px #0008, 0 0 0 4px #5edfff33 !important;
  border: 1.5px solid var(--border-dark) !important;
}
.notif-dropdown-fix {
  pointer-events: auto !important;
}
</style>
                        <div class="fw-bold mb-2">اعلانات</div>
                        <div id="notifMsgContainer"></div>
                    </div>
                </div>
                <!-- Dark/Light Mode Switch -->
                <div class="theme-switch" title="تغییر حالت روشن/تاریک">
                    <input type="checkbox" id="theme-toggle" aria-label="تغییر تم">
                    <span class="theme-toggle-slider"></span>
                    <span class="theme-toggle-knob">
                        <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="5"/><g><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></g></svg>
                        <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21 12.79A9 9 0 0 1 12.21 3a7 7 0 1 0 8.79 9.79z"/></svg>
                    </span>
                </div>
                <form action="/logout/" method="post" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-danger ms-2">خروج</button>
                </form>
            {% else %}
                <div class="theme-switch ms-3">
                    <input type="checkbox" id="theme-toggle">
                    <span class="theme-toggle-slider"></span>
                    <span class="theme-toggle-knob">
                        <span class="icon-sun">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><g><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></g></svg>
                        </span>
                        <span class="icon-moon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 0 1 12.21 3a7 7 0 1 0 8.79 9.79z"/></svg>
                        </span>
                    </span>
                </div>
                <a href="/login/" class="btn btn-outline-primary ms-2">ورود</a>
            {% endif %}
        </div>
        {% block navbar %}{% endblock %}
    </div>
</nav>
<style>
    .vertical-actions {
        position: fixed;
        right: 0;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 0;
        z-index: 1000;
        background: #181a23 !important;
        box-shadow: 0 4px 24px #23243a66;
        border-radius: 16px;
        padding: 0.5rem 0.2rem;
        min-width: unset;
    }
    .vertical-actions a {
        margin: 0 !important;
        border-radius: 0 !important;
        min-width: 120px;
        max-width: 120px;
        font-size: 1rem !important;
        padding: 0.7rem 0.7rem !important;
        box-shadow: none !important;
        border-top: 1.5px solid #23243a;
        background: #23243a !important;
        color: #fff !important;
        transition: background 0.2s;
        text-align: center;
    }
    .vertical-actions a:hover {
        background: #10111a !important;
        color: #5edfff !important;
    }
    .vertical-actions a:first-child {
        border-top: none;
    }
</style>
<div class="vertical-actions">
    <a href="/upload/" class="btn btn-primary shadow">آپلود فایل جدید</a>
    <a href="/my-files/" class="btn btn-outline-primary shadow">فایل‌های من</a>
    <a href="/files/" class="btn btn-outline-primary shadow">فایل‌های قابل مشاهده</a>
    <a href="/chats/" class="btn btn-outline-primary shadow">چت با اعضا</a>
    <a href="{% url 'project_list' %}" class="btn btn-outline-primary shadow">پروژه‌ها و تسک‌ها</a>
    {% if request.user.is_authenticated %}
        <a href="{% url 'user_projects' %}" class="btn btn-outline-primary shadow">تسک‌های من</a>
        <a href="{% url 'user_reports' %}" class="btn btn-outline-primary shadow">گزارش‌های من</a>
    {% endif %}
    {% if request.user.is_staff %}
        <a href="/admin/" class="btn btn-outline-primary shadow">پنل مدیریت</a>
        <a href="/admin2" class="btn btn-outline-primary shadow">پنل مدیر</a>
    {% endif %}
</div>
<div class="container">
    {# حذف نمایش پیام‌های Django در بالای صفحات #}
    {% block content %}{% endblock %}
</div>
<footer class="footer fixed-bottom"
    style="background:var(--footer-bg,rgba(243,244,248,0.85)); border-top:1px solid var(--footer-border,var(--border-light)); box-shadow:0 -2px 12px #e3e6ed40; padding:0.5rem 0;">
    <div class="container text-center p-0">
        <span id="footerText" style="font-size:1em; color:var(--footer-color,var(--muted-light));">© 2025 Nati</span>
    </div>
</footer>
<script>
// fix bug ke footer ba taghir light mode avaz nemishod
// hanoz moshkel dare ___________________________________________________________________________________________________________________
function syncFooterTheme() {
    const html = document.documentElement;
    const footer = document.querySelector('footer.footer');
    const footerText = document.getElementById('footerText');
    if (html.classList.contains('dark')) {
        footer.style.background = 'rgba(35,36,58,0.92)';
        footer.style.borderTop = '1px solid #33374d';
        footerText.style.color = '#b3c6ff';
    } else {
        footer.style.background = 'rgba(243,244,248,0.85)';
        footer.style.borderTop = '1px solid #e0e0e0';
        footerText.style.color = '#888';
    }
}
// hanoz moshkel dare ___________________________________________________________________________
document.addEventListener('DOMContentLoaded', function() {
    syncFooterTheme();
    const switchInput = document.getElementById('theme-toggle');
    if (switchInput) {
        switchInput.addEventListener('change', syncFooterTheme);
    }
});
</script>
<script>
function toggleNotifDropdown(e) {
    e.stopPropagation();
    const dropdown = document.getElementById('notifDropdown');
    const dot = document.getElementById('notifDot');
    if (dropdown.style.display === 'none' || dropdown.style.display === '') {
        dropdown.style.display = 'block';
        if (dot) dot.style.display = 'none';
        localStorage.setItem('notif_seen', '1');
    } else {
        dropdown.style.display = 'none';
    }
}
document.addEventListener('click', function(e) {
    const btn = document.getElementById('notifBtn');
    const dropdown = document.getElementById('notifDropdown');
    if (dropdown && !dropdown.contains(e.target) && e.target !== btn) {
        dropdown.style.display = 'none';
    }
});
    document.addEventListener('DOMContentLoaded', function() {
        const switchInput = document.getElementById('theme-toggle');
        const body = document.body;
        const html = document.documentElement;
 
        const notifDot = document.getElementById('notifDot');
        if (notifDot && localStorage.getItem('notif_seen') === '1') {
            notifDot.style.display = 'none';
        }
        // fix bug ke bayad refresh mikardi | az ghabl load dark va light moshakhas mishe
        if (localStorage.getItem('theme') === 'dark') {
            body.classList.add('dark');
            html.classList.add('dark');
            if (switchInput) switchInput.checked = true;
        } else {
            body.classList.remove('dark');
            html.classList.remove('dark');
            if (switchInput) switchInput.checked = false;
        }
        if (switchInput) {
            //  bug dareeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee _________
            switchInput.parentElement.addEventListener('click', function(e) {
                if (e.target === switchInput) return;
                switchInput.checked = !switchInput.checked;
                switchInput.dispatchEvent(new Event('change'));
            });
            //  ____________________________________________________________________________________
            switchInput.addEventListener('change', function() {
                if (this.checked) {
                    body.classList.add('dark');
                    html.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                } else {
                    body.classList.remove('dark');
                    html.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                }
            });
        }
    });
</script>
<script>
// cancel shod 
let shownNotifs = {};
function fetchNotifications() {
    fetch('/notifications/api/unread/', {credentials: 'same-origin'})
        .then(r => r.json())
        .then((data) => {
            const container = document.getElementById('notifMsgContainer');
            let html = '';
            let hasNotif = false;
            let newNotif = false;
            if (data.notifications && data.notifications.length > 0) {
                // fix bug ke be ezaye har payam yek notif miomad 
                // hala kolan yek payam miad ta seen nashode payam jadid nemiad
                let unseen = JSON.parse(localStorage.getItem('notif_seen_ids') || '{}');
                data.notifications.forEach(n => {
                    html += `<div class=\"alert alert-info py-2 mb-2 notif-alert\" data-sender=\"${n.sender_id}\">${n.sender_fullname} به شما پیام داد</div>`;
                    hasNotif = true;
                    if (!unseen[n.sender_id]) {
                        newNotif = true;
                        unseen[n.sender_id] = true;
                    }
                });
                localStorage.setItem('notif_seen_ids', JSON.stringify(unseen));
            } else {

                localStorage.removeItem('notif_seen_ids');
            }
            container.innerHTML = html || '<div class="text-muted">اعلان جدیدی ندارید.</div>';

            const notifDot = document.getElementById('notifDot');
            if (notifDot) {
                if (hasNotif) {
                    notifDot.style.display = 'block';
                } else {
                    notifDot.style.display = 'none';
                }
            }

 
            if (newNotif && !window._notifDropdownShown) {
                window._notifDropdownShown = true;
                const dropdown = document.getElementById('notifDropdown');
                if (dropdown) {
                    dropdown.style.display = 'block';
                    setTimeout(() => {
                        dropdown.style.display = 'none';
                        window._notifDropdownShown = false;
                    }, 7000);
                }
            }
        });
}
setInterval(fetchNotifications, 7000);
fetchNotifications();
//
window.removeNotifForSender = function(sender_id) {
    shownNotifs[sender_id] = false;
    fetchNotifications();
}
</script>
{% block scripts %}{% endblock %}
<script>
function toggleNotifDropdown(event) {
    var btn = document.getElementById('notifBtn');
    var dropdown = document.getElementById('notifDropdown');
    if (!btn || !dropdown) return;
    if (dropdown.style.display === 'none' || dropdown.style.display === '') {
        var rect = btn.getBoundingClientRect();
        dropdown.style.display = 'block';
        dropdown.style.position = 'fixed';
        dropdown.style.right = (window.innerWidth - rect.right) + 'px';
        dropdown.style.top = (rect.bottom + 6) + 'px';
        dropdown.style.left = 'auto';
        dropdown.style.zIndex = '2147483647';
    } else {
        dropdown.style.display = 'none';
    }
    event.stopPropagation();
}
// بستن باکس با کلیک بیرون
window.addEventListener('click', function(e) {
    var dropdown = document.getElementById('notifDropdown');
    if (dropdown) dropdown.style.display = 'none';
});
var notifBtn = document.getElementById('notifBtn');
if (notifBtn) {
    notifBtn.addEventListener('click', function(e) {
        toggleNotifDropdown(e);
        e.stopPropagation();
    });
}
</script>
</body>
</html>
